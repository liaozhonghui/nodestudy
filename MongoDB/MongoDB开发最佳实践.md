# MongoDB最佳实践

## 连接到MongoDB
- 关于驱动程序: 从驱动兼容对照表中进行检查
- 关于连接对象 MongoClient 使用MondoClient对象连接到mongoDB实例时总是应该保证它单例，并且在整个生命周期中都是从它获取其他操作对象
- 连接字符串：连接字符串中可以配置大部分连接选项，建议总是在连接字符串中配置这些选项

连接到复制集： mongodb://节点1，街店，节点3，.../database?[option]
连接到分片集： mongodb://mongs1,mongs2,mongs3,...//database?[options]

常见连接字符串参数
maxPoolSize 连接池大小
Max Wait Time 建议设置，自动杀掉太慢的查询
Write Concern 建议设置majority保证数据安全
Read Concern 对于数据一致性要求高的时候需要设置

连接字符串节点

使用域名连接集群
直接通过域名解析，或者也可以使用mongodb+srv://协议

不要在mongos前面使用负载均衡

游标使用，如果游标已经遍历完成，则会自动关闭，如果没有遍历完，要手动close

## 关于查询和索引

每一个查询都必须要有对应的索引

尽量使用覆盖索引coverd indexes (可以避免读数据文件)
使用projection来减少返回到客户端的文档的内容

## 关于写入
- 在update语句中只包括需要更新的字段
- 尽可能使用批量插入来提升写入性能
- 使用TTL自动国旗日志类型的数据

## 关于文档结构
- 防止使用过长的字段名称
- 防止使用太深的数组嵌套
- 不使用中文，标点符号等非拉丁字母作为字段名

## 处理分页问题
尽可能不要计算总页数

避免使用skip/limit形式的分页，特别是数据量特别巨大的时候，
替代方案： 使用查询条件+唯一排序条件
eg:
第一页： db.ports.find({}).sort({ _id: 1 }).limit(20)
第二页： db.posts.find({_id: {$gt: <第一页最后一个_id>}}).sort({_id: 1}).limit(20)
第三页： db.posts.find({_id: {$gt: <第二页最后一个_id>}}).sort({_id: 1}).limit(20)
  

## 关于事务
使用事务的原则
- 无论何时，事务的使用总是能够避免则避免
- 模型设计县域事务，尽可能用模型设计规避事务
- 不要使用过大的事务（尽量控制在1000个文档更新以内）；
- 党必须使用事务的时候，尽可能让涉及事务的文档分布在同一个分片上，这将有效的提高效率




